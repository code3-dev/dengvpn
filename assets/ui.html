<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DengVPN</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    :root {
      /* Dark theme variables */
      --primary-color: #6C5CE7;
      --primary-hover: #5649C0;
      --secondary-color: #2C2F47;
      --text-color: #ffffff;
      --bg-color: #1A1C2E;
      --card-color: #252839;
      --card-hover: #2E3150;
      --connected-color: #00D0A6;
      --disconnected-color: #FF6B6B;
      --button-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
      --accent-gradient: linear-gradient(135deg, #6C5CE7, #00D0A6);
      --header-height: 70px;
      --border-radius: 16px;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.5);
      --card-padding: clamp(15px, 4vw, 40px);
      --container-max-width: min(95%, 1200px);
      --transition-speed: 0.3s;
    }

    /* Light theme variables */
    .light-theme {
      --primary-color: #6C5CE7;
      --primary-hover: #5649C0;
      --secondary-color: #F0F2F5;
      --text-color: #333333;
      --bg-color: #FFFFFF;
      --card-color: #FFFFFF;
      --card-hover: #F8F9FA;
      --button-shadow: 0 10px 20px rgba(108, 92, 231, 0.2);
      --text-secondary: rgba(0, 0, 0, 0.7);
      --text-tertiary: rgba(0, 0, 0, 0.5);
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 16px;
      line-height: 1.5;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 100%;
      overflow: hidden;
    }

    /* Header Styles */
    .header {
      height: var(--header-height);
      background: rgba(30, 30, 45, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 clamp(15px, 4vw, 30px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      z-index: 10;
      position: relative;
      flex-shrink: 0;
    }

    .light-theme .header {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      font-size: clamp(18px, 5vw, 24px);
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .theme-toggle {
      background: var(--card-color);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all var(--transition-speed);
    }

    .theme-toggle:hover {
      transform: rotate(15deg);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      background: rgba(30, 30, 45, 0.8);
      padding: 8px 16px;
      border-radius: 30px;
      font-weight: 500;
      font-size: clamp(12px, 3vw, 14px);
    }

    .light-theme .status-indicator {
      background: rgba(255, 255, 255, 0.8);
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
      background-color: var(--disconnected-color);
      box-shadow: 0 0 10px var(--disconnected-color);
      flex-shrink: 0;
      transition: all var(--transition-speed);
    }

    .dot.connected {
      background-color: var(--connected-color);
      box-shadow: 0 0 10px var(--connected-color);
    }

    .proxy-status {
      padding: 8px 16px;
      background: rgba(30, 30, 45, 0.8);
      border-radius: 30px;
      font-size: clamp(12px, 3vw, 14px);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .light-theme .proxy-status {
      background: rgba(255, 255, 255, 0.8);
    }

    .proxy-enabled {
      color: var(--connected-color);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Connection Card */
    .connection-card {
      background-color: var(--card-color);
      border-radius: var(--border-radius);
      padding: var(--card-padding);
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
      animation: cardAppear 0.4s ease-out;
    }

    .light-theme .connection-card {
      box-shadow: var(--card-shadow);
    }

    @keyframes cardAppear {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 5px rgba(108, 92, 231, 0.5); }
      50% { box-shadow: 0 0 20px rgba(108, 92, 231, 0.8); }
      100% { box-shadow: 0 0 5px rgba(108, 92, 231, 0.5); }
    }

    .connection-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--accent-gradient);
    }

    .connection-status {
      font-size: clamp(18px, 5vw, 24px);
      margin-bottom: clamp(15px, 5vh, 30px);
      text-align: center;
    }

    .connection-status-name {
      font-size: clamp(14px, 3vw, 18px);
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 30px;
      font-weight: 500;
    }

    /* Server Selection */
    .server-selection {
      margin-bottom: 30px;
    }

    .server-select {
      width: 100%;
      padding: 15px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-color);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      outline: none;
      transition: all var(--transition-speed);
    }

    .light-theme .server-select {
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .server-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.3);
    }

    .server-select option {
      background: var(--card-color);
      color: var(--text-color);
    }

    .light-theme .server-select option {
      background: #FFFFFF;
      color: #333333;
    }

    /* Connect Button */
    .connect-button {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: all var(--transition-speed);
      box-shadow: var(--button-shadow);
      width: 100%;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }

    .connect-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(108, 92, 231, 0.4);
    }

    .connect-button:active {
      transform: translateY(0);
    }

    .connect-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .connect-button.disconnected::before {
      content: 'Connect';
    }

    .connect-button.connected::before {
      content: 'Disconnect';
    }

    /* Ping Display */
    .ping-display {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      margin: 10px 0;
      min-height: 20px;
    }

    .ping-value {
      font-weight: 600;
      color: var(--primary-color);
    }

    /* Connection Time */
    .connection-time {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 10px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        padding: 0 15px;
      }
      
      .header-left {
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      .main-content {
        padding: 20px;
      }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover);
    }

    .light-theme ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo">DengVPN</div>
        <button class="theme-toggle" id="themeToggle">
          <span class="material-icons">dark_mode</span>
        </button>
      </div>
      <div class="header-right">
        <div class="status-indicator">
          <div class="dot" id="connectionDot"></div>
          <span id="connectionStatusText">Disconnected</span>
        </div>
        <div class="proxy-status" id="proxyStatus">
          Proxy: Disabled
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="connection-card">
        <h2 class="connection-status">Ready to Connect</h2>
        <p class="connection-status-name" id="connectionStatusName">No server selected</p>
        
        <!-- Server Selection -->
        <div class="server-selection">
          <select class="server-select" id="serverSelect">
            <option value="-1">Select a server</option>
            <!-- Options will be populated by JavaScript -->
          </select>
        </div>
        
        <!-- Connect Button -->
        <button class="connect-button disconnected" id="connectButton" disabled>
          Connect
        </button>
        
        <!-- Ping Display -->
        <div class="ping-display" id="pingDisplay">
          Ping: <span class="ping-value" id="pingValue">--</span> ms
        </div>
        
        <!-- Connection Time -->
        <div class="connection-time" id="connectionTime">
          Connection time: --:--:--
        </div>
      </div>
    </main>
  </div>

  <script>
    // App state
    let isConnected = false;
    let selectedServerIndex = -1;
    let configs = [];
    let connectionStartTime = null;
    let connectionTimer = null;
    let pingInterval = null;
    let currentPing = '--';

    // DOM Elements
    const connectButton = document.getElementById('connectButton');
    const serverSelect = document.getElementById('serverSelect');
    const connectionDot = document.getElementById('connectionDot');
    const connectionStatusText = document.getElementById('connectionStatusText');
    const connectionStatusName = document.getElementById('connectionStatusName');
    const proxyStatus = document.getElementById('proxyStatus');
    const connectionTime = document.getElementById('connectionTime');
    const themeToggle = document.getElementById('themeToggle');
    const pingDisplay = document.getElementById('pingDisplay');
    const pingValue = document.getElementById('pingValue');

    // Theme Toggle
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-theme');
      const icon = themeToggle.querySelector('.material-icons');
      if (document.body.classList.contains('light-theme')) {
        icon.textContent = 'light_mode';
      } else {
        icon.textContent = 'dark_mode';
      }
    });

    // Format server name
    function formatServerName(config) {
      if (config.name) {
        return config.name;
      }
      
      if (config.remarks) {
        return config.remarks;
      }
      
      if (config.ps) {
        return config.ps;
      }
      
      // For VLESS/VMess URLs, try to extract name from fragment
      if (typeof config === 'string') {
        try {
          const url = new URL(config);
          if (url.hash) {
            return decodeURIComponent(url.hash.substring(1));
          }
        } catch (e) {
          // Ignore parsing errors
        }
      }
      
      return 'Unnamed Server';
    }

    // Select server
    function selectServer(index) {
      selectedServerIndex = index;
      
      const config = configs[index];
      if (config) {
        connectionStatusName.textContent = formatServerName(config);
        connectButton.disabled = false;
      } else {
        connectionStatusName.textContent = 'No server selected';
        connectButton.disabled = true;
      }
    }

    // Update connection status
    function updateConnectionStatus(connected) {
      isConnected = connected;
      
      if (connected) {
        connectionDot.classList.add('connected');
        connectionStatusText.textContent = 'Connected';
        connectButton.classList.remove('disconnected');
        connectButton.classList.add('connected');
        connectButton.textContent = 'Disconnect';
        
        // Start connection timer
        connectionStartTime = new Date();
        startConnectionTimer();
        
        // Start ping interval
        startPingInterval();
      } else {
        connectionDot.classList.remove('connected');
        connectionStatusText.textContent = 'Disconnected';
        connectButton.classList.remove('connected');
        connectButton.classList.add('disconnected');
        connectButton.textContent = 'Connect';
        
        // Stop connection timer
        stopConnectionTimer();
        connectionTime.textContent = 'Connection time: --:--:--';
        
        // Stop ping interval
        stopPingInterval();
        pingValue.textContent = '--';
      }
    }

    // Start connection timer
    function startConnectionTimer() {
      stopConnectionTimer();
      connectionTimer = setInterval(() => {
        if (connectionStartTime) {
          const now = new Date();
          const diff = new Date(now - connectionStartTime);
          const hours = diff.getUTCHours().toString().padStart(2, '0');
          const minutes = diff.getUTCMinutes().toString().padStart(2, '0');
          const seconds = diff.getUTCSeconds().toString().padStart(2, '0');
          connectionTime.textContent = `Connection time: ${hours}:${minutes}:${seconds}`;
        }
      }, 1000);
    }

    // Stop connection timer
    function stopConnectionTimer() {
      if (connectionTimer) {
        clearInterval(connectionTimer);
        connectionTimer = null;
      }
    }

    // Start ping interval
    function startPingInterval() {
      stopPingInterval();
      // Initial ping
      measurePing();
      // Ping every 5 seconds
      pingInterval = setInterval(measurePing, 5000);
    }

    // Stop ping interval
    function stopPingInterval() {
      if (pingInterval) {
        clearInterval(pingInterval);
        pingInterval = null;
      }
    }

    // Measure ping to Google's connectivity check
    async function measurePing() {
      if (!isConnected) return;
      
      try {
        const startTime = Date.now();
        const response = await fetch('https://www.gstatic.com/generate_204', { 
          method: 'GET',
          cache: 'no-cache',
          mode: 'no-cors' // Using no-cors to avoid preflight issues
        });
        const endTime = Date.now();
        const pingTime = endTime - startTime;
        
        // Update ping display
        pingValue.textContent = pingTime;
        currentPing = pingTime;
      } catch (error) {
        console.error('Ping error:', error);
        pingValue.textContent = 'Error';
        currentPing = 'Error';
      }
    }

    // Toggle connection
    function toggleConnection() {
      if (isConnected) {
        window.vpn.disconnect();
      } else if (selectedServerIndex >= 0) {
        const config = configs[selectedServerIndex];
        if (config.name && config.url && !config.jsonFile) {
          // New format with name and url properties but no jsonFile - use URL
          window.vpn.connectWithUrl(config.url);
        } else {
          // Either old format or new format with jsonFile - use index
          window.vpn.connect(selectedServerIndex);
        }
      }
    }

    // Handle server selection change
    function handleServerChange(index) {
      if (index >= 0) {
        selectServer(index);
        
        // If already connected, switch to the new server immediately
        if (isConnected) {
          const config = configs[index];
          if (config.name && config.url && !config.jsonFile) {
            // New format with name and url properties but no jsonFile - use URL
            window.vpn.connectWithUrl(config.url);
          } else {
            // Either old format or new format with jsonFile - use index
            window.vpn.connect(index);
          }
        }
      }
    }

    // Render server list in dropdown
    function renderServerList() {
      serverSelect.innerHTML = '<option value="-1">Select a server</option>';
      
      configs.forEach((config, index) => {
        const serverName = formatServerName(config);
        
        // Select dropdown option
        const option = document.createElement('option');
        option.value = index;
        option.textContent = serverName;
        if (index === selectedServerIndex) {
          option.selected = true;
        }
        serverSelect.appendChild(option);
      });
    }

    // Event listeners
    connectButton.addEventListener('click', toggleConnection);
    serverSelect.addEventListener('change', (e) => {
      const index = parseInt(e.target.value);
      handleServerChange(index);
    });

    // Initialize the app
    function initApp() {
      // Get configs from main process
      window.vpn.getConfigs();
      
      // Listen for config updates
      window.vpn.onUpdateConfigs((updatedConfigs) => {
        configs = updatedConfigs;
        renderServerList();
      });
      
      // Listen for connection status updates
      window.vpn.onConnectionStatus((connected) => {
        updateConnectionStatus(connected);
      });
    }

    // Initialize when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>